<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Field interpolation example &#8212; bfieldtools  documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery-dataframe.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Coil with minimal eddy currents" href="pub_minimal_eddy_current_cylindrical_coil_design.html" />
    <link rel="prev" title="Magnetically shielded coil" href="pub_magnetically_shielded_biplanar_coil_design.html" />
    <link rel="stylesheet" href="../../_static/style.css " type="text/css" />
    <link rel="stylesheet" href="../../_static/font-awesome.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/font-source-code-pro.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/font-source-sans-pro.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/flag-icon.css" type="text/css" />
    

<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js "></script>


  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html"><span><img src="../../_static/logo_simple.png"></span>
          bfieldtools</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../overview.html">Overview</a></li>
                <li><a href="../../installation.html">Install</a></li>
                <li><a href="../../literature.html">Literature</a></li>
                <li><a href="../index.html">Examples</a></li>
                <li><a href="../../api_reference.html">API</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#documentation">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#installing-bfieldtools">Installing bfieldtools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#citing-bfieldtools">Citing bfieldtools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#contributing">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#license">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../literature.html">Literature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../literature.html#related-software">Related software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Example gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#coil-design">Coil design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#physics-publication-examples">Physics publication examples</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html#software-publication-examples">Software publication examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#thermal-noise-computation">Thermal noise computation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#validation">Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html">API Reference</a></li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo_simple.png" alt="Logo"/>
            </a></p><ul>
<li><a class="reference internal" href="#">Field interpolation example</a></li>
</ul>

  <li>
    <a href="pub_magnetically_shielded_biplanar_coil_design.html" title="Previous Chapter: Magnetically shielded coil"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Magnetically ...</span>
    </a>
  </li>
  <li>
    <a href="pub_minimal_eddy_current_cylindrical_coil_design.html" title="Next Chapter: Coil with minimal eddy currents"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Coil with min... &raquo;</span>
    </a>
  </li>
<form action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="body col-md-12 content" role="main">
      
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-examples-publication-software-mne-interpolation-py"><span class="std std-ref">here</span></a>     to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="field-interpolation-example">
<span id="sphx-glr-auto-examples-publication-software-mne-interpolation-py"></span><h1>Field interpolation example<a class="headerlink" href="#field-interpolation-example" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">bfieldtools.mesh_conductor</span> <span class="kn">import</span> <span class="n">MeshConductor</span><span class="p">,</span> <span class="n">StreamFunction</span>
<span class="kn">from</span> <span class="nn">mayavi</span> <span class="kn">import</span> <span class="n">mlab</span>
<span class="kn">import</span> <span class="nn">trimesh</span>

<span class="kn">import</span> <span class="nn">mne</span>

<span class="n">PLOT</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">IMPORT_MNE_DATA</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">SAVE_MNE_DATA</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">SAVE_DIR</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>

<span class="k">if</span> <span class="n">IMPORT_MNE_DATA</span><span class="p">:</span>

    <span class="kn">from</span> <span class="nn">mne.datasets</span> <span class="kn">import</span> <span class="n">sample</span>

    <span class="n">data_path</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">data_path</span><span class="p">()</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">data_path</span> <span class="o">+</span> <span class="s2">&quot;/MEG/sample/sample_audvis-ave.fif&quot;</span>
    <span class="c1"># Reading</span>
    <span class="n">condition</span> <span class="o">=</span> <span class="s2">&quot;Left Auditory&quot;</span>
    <span class="n">evoked</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_evokeds</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="n">condition</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">proj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">evoked</span><span class="o">.</span><span class="n">pick_types</span><span class="p">(</span><span class="n">meg</span><span class="o">=</span><span class="s2">&quot;mag&quot;</span><span class="p">)</span>
    <span class="n">evoked</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[],</span> <span class="n">time_unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>

    <span class="n">i0</span><span class="p">,</span> <span class="n">i1</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">time_as_index</span><span class="p">(</span><span class="mf">0.08</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evoked</span><span class="o">.</span><span class="n">time_as_index</span><span class="p">(</span><span class="mf">0.09</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Read BEM for surface geometry and transform to correct coordinate system</span>
    <span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>

    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;sample&quot;</span>
    <span class="n">subjects_dir</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;subjects&quot;</span><span class="p">)</span>
    <span class="n">bem_fname</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">subjects_dir</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;bem&quot;</span><span class="p">,</span> <span class="n">subject</span> <span class="o">+</span> <span class="s2">&quot;-5120-5120-5120-bem-sol.fif&quot;</span>
    <span class="p">)</span>
    <span class="n">bem</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_bem_solution</span><span class="p">(</span><span class="n">bem_fname</span><span class="p">)</span>

    <span class="c1"># Head mesh 0</span>
    <span class="c1"># Innerskull mesh 2</span>
    <span class="n">surf_index</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">trans_fname</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;MEG&quot;</span><span class="p">,</span> <span class="s2">&quot;sample&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_audvis_raw-trans.fif&quot;</span><span class="p">)</span>
    <span class="n">trans0</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_trans</span><span class="p">(</span><span class="n">trans_fname</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">trans0</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">trans0</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="c1"># Surface from MRI to HEAD</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">bem</span><span class="p">[</span><span class="s2">&quot;surfs&quot;</span><span class="p">][</span><span class="n">surf_index</span><span class="p">][</span><span class="s2">&quot;rr&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">@</span> <span class="n">R</span>
    <span class="c1"># Surface from HEAD to DEVICE</span>
    <span class="n">trans1</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;dev_head_t&quot;</span><span class="p">]</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">trans1</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">trans1</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">rr</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">@</span> <span class="n">R</span>

    <span class="n">mesh</span> <span class="o">=</span> <span class="n">trimesh</span><span class="o">.</span><span class="n">Trimesh</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">bem</span><span class="p">[</span><span class="s2">&quot;surfs&quot;</span><span class="p">][</span><span class="n">surf_index</span><span class="p">][</span><span class="s2">&quot;tris&quot;</span><span class="p">])</span>
    <span class="n">mlab</span><span class="o">.</span><span class="n">triangular_mesh</span><span class="p">(</span><span class="o">*</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">)</span>

    <span class="n">surf_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">trans0</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">trans0</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="c1"># Surface from MRI to HEAD</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">bem</span><span class="p">[</span><span class="s2">&quot;surfs&quot;</span><span class="p">][</span><span class="n">surf_index</span><span class="p">][</span><span class="s2">&quot;rr&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">@</span> <span class="n">R</span>
    <span class="c1"># Surface from HEAD to DEVICE</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">trans1</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">trans1</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">rr</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">@</span> <span class="n">R</span>
    <span class="n">head</span> <span class="o">=</span> <span class="n">trimesh</span><span class="o">.</span><span class="n">Trimesh</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">bem</span><span class="p">[</span><span class="s2">&quot;surfs&quot;</span><span class="p">][</span><span class="n">surf_index</span><span class="p">][</span><span class="s2">&quot;tris&quot;</span><span class="p">])</span>

    <span class="n">mesh</span> <span class="o">=</span> <span class="n">head</span>

    <span class="c1"># Sensor locations and directions in DEVICE coordinate system</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">evoked</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;chs&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;ch_name&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span> <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;ch_name&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;MEG&quot;</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">evoked</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;chs&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;ch_name&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span> <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;ch_name&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;MEG&quot;</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="kn">from</span> <span class="nn">mne.datasets</span> <span class="kn">import</span> <span class="n">sample</span>

    <span class="n">data_path</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">data_path</span><span class="p">()</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">data_path</span> <span class="o">+</span> <span class="s2">&quot;/MEG/sample/sample_audvis-ave.fif&quot;</span>
    <span class="c1"># Reading</span>
    <span class="n">condition</span> <span class="o">=</span> <span class="s2">&quot;Left Auditory&quot;</span>
    <span class="n">evoked</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_evokeds</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="n">condition</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">proj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">evoked</span><span class="o">.</span><span class="n">pick_types</span><span class="p">(</span><span class="n">meg</span><span class="o">=</span><span class="s2">&quot;mag&quot;</span><span class="p">)</span>
    <span class="n">evoked</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[],</span> <span class="n">time_unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>

    <span class="n">i0</span><span class="p">,</span> <span class="n">i1</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">time_as_index</span><span class="p">(</span><span class="mf">0.08</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evoked</span><span class="o">.</span><span class="n">time_as_index</span><span class="p">(</span><span class="mf">0.09</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Read BEM for surface geometry and transform to correct coordinate system</span>
    <span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>

    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;sample&quot;</span>
    <span class="n">subjects_dir</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;subjects&quot;</span><span class="p">)</span>
    <span class="n">bem_fname</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">subjects_dir</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="s2">&quot;bem&quot;</span><span class="p">,</span> <span class="n">subject</span> <span class="o">+</span> <span class="s2">&quot;-5120-5120-5120-bem-sol.fif&quot;</span>
    <span class="p">)</span>
    <span class="n">bem</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_bem_solution</span><span class="p">(</span><span class="n">bem_fname</span><span class="p">)</span>

    <span class="c1"># Head mesh 0</span>
    <span class="c1"># Innerskull mesh 2</span>
    <span class="n">surf_index</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">trans_fname</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;MEG&quot;</span><span class="p">,</span> <span class="s2">&quot;sample&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_audvis_raw-trans.fif&quot;</span><span class="p">)</span>
    <span class="n">trans0</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_trans</span><span class="p">(</span><span class="n">trans_fname</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">trans0</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">trans0</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="c1"># Surface from MRI to HEAD</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">bem</span><span class="p">[</span><span class="s2">&quot;surfs&quot;</span><span class="p">][</span><span class="n">surf_index</span><span class="p">][</span><span class="s2">&quot;rr&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">@</span> <span class="n">R</span>
    <span class="c1"># Surface from HEAD to DEVICE</span>
    <span class="n">trans1</span> <span class="o">=</span> <span class="n">evoked</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;dev_head_t&quot;</span><span class="p">]</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">trans1</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">trans1</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">rr</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">@</span> <span class="n">R</span>

    <span class="n">mesh</span> <span class="o">=</span> <span class="n">trimesh</span><span class="o">.</span><span class="n">Trimesh</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">bem</span><span class="p">[</span><span class="s2">&quot;surfs&quot;</span><span class="p">][</span><span class="n">surf_index</span><span class="p">][</span><span class="s2">&quot;tris&quot;</span><span class="p">])</span>
    <span class="n">mlab</span><span class="o">.</span><span class="n">triangular_mesh</span><span class="p">(</span><span class="o">*</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">)</span>

    <span class="n">surf_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">trans0</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">trans0</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="c1"># Surface from MRI to HEAD</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">bem</span><span class="p">[</span><span class="s2">&quot;surfs&quot;</span><span class="p">][</span><span class="n">surf_index</span><span class="p">][</span><span class="s2">&quot;rr&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">@</span> <span class="n">R</span>
    <span class="c1"># Surface from HEAD to DEVICE</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">trans1</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">trans1</span><span class="p">[</span><span class="s2">&quot;trans&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">rr</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">@</span> <span class="n">R</span>
    <span class="n">head</span> <span class="o">=</span> <span class="n">trimesh</span><span class="o">.</span><span class="n">Trimesh</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">bem</span><span class="p">[</span><span class="s2">&quot;surfs&quot;</span><span class="p">][</span><span class="n">surf_index</span><span class="p">][</span><span class="s2">&quot;tris&quot;</span><span class="p">])</span>

    <span class="n">mesh</span> <span class="o">=</span> <span class="n">head</span>

    <span class="c1"># Sensor locations and directions in DEVICE coordinate system</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">evoked</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;chs&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;ch_name&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span> <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;ch_name&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;MEG&quot;</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">evoked</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;chs&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;ch_name&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="ow">and</span> <span class="n">ch</span><span class="p">[</span><span class="s2">&quot;ch_name&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;MEG&quot;</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">PLOT</span><span class="p">:</span>
        <span class="c1"># Plot sensor locations and directions</span>
        <span class="n">mlab</span><span class="o">.</span><span class="n">triangular_mesh</span><span class="p">(</span>
            <span class="o">*</span><span class="n">head</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">head</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span>
        <span class="p">)</span>
        <span class="n">mlab</span><span class="o">.</span><span class="n">quiver3d</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;arrow&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">SAVE_MNE_DATA</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span>
            <span class="n">SAVE_DIR</span> <span class="o">+</span> <span class="s2">&quot;mne_data.npz&quot;</span><span class="p">,</span>
            <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span>
            <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span>
            <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
            <span class="n">vertices</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span>
            <span class="n">faces</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">evoked</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">SAVE_DIR</span> <span class="o">+</span> <span class="s2">&quot;left_auditory-ave.fif&quot;</span><span class="p">)</span>


<span class="k">else</span><span class="p">:</span>

    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">SAVE_DIR</span> <span class="o">+</span> <span class="s2">&quot;mne_data.npz&quot;</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;mesh&quot;</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">trimesh</span><span class="o">.</span><span class="n">Trimesh</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;vertices&quot;</span><span class="p">],</span> <span class="n">faces</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;faces&quot;</span><span class="p">])</span>

    <span class="n">evoked</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">Evoked</span><span class="p">(</span><span class="n">SAVE_DIR</span> <span class="o">+</span> <span class="s2">&quot;left_auditory-ave.fif&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><img alt="../../_images/sphx_glr_mne_interpolation_001.png" class="sphx-glr-multi-img" src="../../_images/sphx_glr_mne_interpolation_001.png" />
</li>
<li><img alt="../../_images/sphx_glr_mne_interpolation_002.png" class="sphx-glr-multi-img" src="../../_images/sphx_glr_mne_interpolation_002.png" />
</li>
</ul>
<img alt="../../_images/sphx_glr_mne_interpolation_003.png" class="sphx-glr-single-img" src="../../_images/sphx_glr_mne_interpolation_003.png" />
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Reading /home/rzetter/mne_data/MNE-sample-data/MEG/sample/sample_audvis-ave.fif ...
    Read a total of 4 projection items:
        PCA-v1 (1 x 102) active
        PCA-v2 (1 x 102) active
        PCA-v3 (1 x 102) active
        Average EEG reference (1 x 60) active
    Found the data of interest:
        t =    -199.80 ...     499.49 ms (Left Auditory)
        0 CTF compensation matrices available
        nave = 55 - aspect type = 100
Projections have already been applied. Setting proj attribute to True.
Applying baseline correction (mode: mean)
Loading surfaces...
Three-layer model surfaces loaded.

Loading the solution matrix...

Loaded linear_collocation BEM solution from /home/rzetter/mne_data/MNE-sample-data/subjects/sample/bem/sample-5120-5120-5120-bem-sol.fif
Reading /home/rzetter/mne_data/MNE-sample-data/MEG/sample/sample_audvis-ave.fif ...
    Read a total of 4 projection items:
        PCA-v1 (1 x 102) active
        PCA-v2 (1 x 102) active
        PCA-v3 (1 x 102) active
        Average EEG reference (1 x 60) active
    Found the data of interest:
        t =    -199.80 ...     499.49 ms (Left Auditory)
        0 CTF compensation matrices available
        nave = 55 - aspect type = 100
Projections have already been applied. Setting proj attribute to True.
Applying baseline correction (mode: mean)
Loading surfaces...
Three-layer model surfaces loaded.

Loading the solution matrix...

Loaded linear_collocation BEM solution from /home/rzetter/mne_data/MNE-sample-data/subjects/sample/bem/sample-5120-5120-5120-bem-sol.fif
</pre></div>
</div>
<p>Fit the surface current for the auditory evoked response</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">MeshConductor</span><span class="p">(</span><span class="n">mesh_obj</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">basis_name</span><span class="o">=</span><span class="s2">&quot;suh&quot;</span><span class="p">,</span> <span class="n">N_suh</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">mass</span>
<span class="c1"># B_sensors = np.sum(c.B_coupling(p) * n[:,:,None], axis=1)</span>
<span class="n">B_sensors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijk,ij-&gt;ik&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">B_coupling</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>
<span class="c1"># a = np.linalg.pinv(B_sensors, rcond=1e-15) @ field</span>
<span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">B_sensors</span> <span class="o">@</span> <span class="n">B_sensors</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

<span class="c1"># reg_exps = [0.5, 1, 2, 3, 4, 5, 6, 7, 8]</span>
<span class="n">reg_exps</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">plot_this</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">rel_errors</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">reg_exp</span> <span class="ow">in</span> <span class="n">reg_exps</span><span class="p">:</span>
    <span class="n">_lambda</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">reg_exp</span><span class="p">))</span>
    <span class="c1"># Laplacian in the suh basis is diagonal</span>
    <span class="n">BB</span> <span class="o">=</span> <span class="n">B_sensors</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">B_sensors</span> <span class="o">+</span> <span class="n">_lambda</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">.</span><span class="n">laplacian</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">laplacian</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">B_sensors</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">field</span><span class="p">)</span>
    <span class="c1"># a = B_sensors.T @ np.linalg.solve(BB, field)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">StreamFunction</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">b_filt</span> <span class="o">=</span> <span class="n">B_sensors</span> <span class="o">@</span> <span class="n">s</span>

    <span class="n">rel_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b_filt</span> <span class="o">-</span> <span class="n">field</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Relative error:&quot;</span><span class="p">,</span> <span class="n">rel_error</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;%&quot;</span><span class="p">)</span>
    <span class="n">rel_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel_error</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_this</span><span class="p">:</span>
        <span class="n">mlab</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">bgcolor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">surf</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">surf</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">interpolate_scalars_before_mapping</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">surf</span><span class="o">.</span><span class="n">module_manager</span><span class="o">.</span><span class="n">scalar_lut_manager</span><span class="o">.</span><span class="n">number_of_colors</span> <span class="o">=</span> <span class="mi">16</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><img alt="../../_images/sphx_glr_mne_interpolation_004.png" class="sphx-glr-multi-img" src="../../_images/sphx_glr_mne_interpolation_004.png" />
</li>
<li><img alt="../../_images/sphx_glr_mne_interpolation_005.png" class="sphx-glr-multi-img" src="../../_images/sphx_glr_mne_interpolation_005.png" />
</li>
</ul>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Calculating surface harmonics expansion...
Computing the laplacian matrix...
Computing the mass matrix...
Closed mesh or Neumann BC, leaving out the constant component
Computing the mass matrix...
Computing magnetic field coupling matrix, 2562 vertices by 102 target points... took 0.19 seconds.
Computing the laplacian matrix...
Relative error: 2.0549237013162216 %
</pre></div>
</div>
<p>%% Interpolate to the sensor surface</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bfieldtools.utils</span> <span class="kn">import</span> <span class="n">load_example_mesh</span>

<span class="n">helmet</span> <span class="o">=</span> <span class="n">load_example_mesh</span><span class="p">(</span><span class="s2">&quot;meg_helmet&quot;</span><span class="p">,</span> <span class="n">process</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># Bring the surface roughly to the correct place</span>
<span class="n">helmet</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.05</span>

<span class="c1"># Reset coupling by hand</span>
<span class="n">c</span><span class="o">.</span><span class="n">B_coupling</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">mlab</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">bgcolor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">B_surf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
    <span class="n">c</span><span class="o">.</span><span class="n">B_coupling</span><span class="p">(</span><span class="n">helmet</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span> <span class="o">*</span> <span class="n">helmet</span><span class="o">.</span><span class="n">vertex_normals</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
<span class="c1"># vecs = c.B_coupling(helmet.vertices)</span>
<span class="n">mlab</span><span class="o">.</span><span class="n">quiver3d</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;arrow&quot;</span><span class="p">)</span>
<span class="n">scalars</span> <span class="o">=</span> <span class="n">B_surf</span> <span class="o">@</span> <span class="n">s</span>
<span class="n">surf</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">triangular_mesh</span><span class="p">(</span>
    <span class="o">*</span><span class="n">helmet</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">helmet</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> <span class="n">scalars</span><span class="o">=</span><span class="n">scalars</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;seismic&quot;</span>
<span class="p">)</span>
<span class="n">surf</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">interpolate_scalars_before_mapping</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">surf</span><span class="o">.</span><span class="n">module_manager</span><span class="o">.</span><span class="n">scalar_lut_manager</span><span class="o">.</span><span class="n">number_of_colors</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">surf2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">surf2</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">interpolate_scalars_before_mapping</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">surf2</span><span class="o">.</span><span class="n">module_manager</span><span class="o">.</span><span class="n">scalar_lut_manager</span><span class="o">.</span><span class="n">number_of_colors</span> <span class="o">=</span> <span class="mi">15</span>

<span class="c1"># mlab.figure()</span>
<span class="c1"># U_surf = c.U_coupling(helmet.vertices)</span>
<span class="c1"># scalars = U_surf @ s</span>
<span class="c1"># surf = mlab.triangular_mesh(*helmet.vertices.T, helmet.faces, scalars=scalars,</span>
<span class="c1">#                     colormap=&#39;seismic&#39;)</span>
<span class="c1"># surf.actor.mapper.interpolate_scalars_before_mapping = True</span>
<span class="c1"># surf.module_manager.scalar_lut_manager.number_of_colors = 15</span>
<span class="c1"># surf2 = s.plot(False)</span>
<span class="c1"># surf2.actor.mapper.interpolate_scalars_before_mapping = True</span>
<span class="c1"># surf2.module_manager.scalar_lut_manager.number_of_colors = 15</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><img alt="../../_images/sphx_glr_mne_interpolation_006.png" class="sphx-glr-multi-img" src="../../_images/sphx_glr_mne_interpolation_006.png" />
</li>
<li><img alt="../../_images/sphx_glr_mne_interpolation_007.png" class="sphx-glr-multi-img" src="../../_images/sphx_glr_mne_interpolation_007.png" />
</li>
</ul>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Computing magnetic field coupling matrix, 2562 vertices by 2044 target points... took 1.32 seconds.
</pre></div>
</div>
<dl>
<dt>#Load simple plane mesh that is centered on the origin</dt><dd><dl class="simple">
<dt>file_obj = pkg_resources.resource_filename(âbfieldtoolsâ,</dt><dd><p>âexample_meshes/10x10_plane_hires.objâ)</p>
</dd>
</dl>
<p>plane = trimesh.load(file_obj, process=True)</p>
</dd>
</dl>
<p>#t = np.eye(4)
#t[1:3,1:3] = np.array([[0,1],[-1,0]])
#mesh.apply_transform(t)</p>
<blockquote>
<div><p>plane.vertices <a href="#id1"><span class="problematic" id="id2">*</span></a>= 0.03</p>
<p>scalars = c.U_coupling(plane.vertices).max(axis=1)
vert_mask = abs(scalars) &gt; np.max(abs(scalars)/10)
face_index = np.nonzero(plane.faces_sparse.T &#64; vert_mask)[0]
plane = plane.subdivide(face_index)</p>
<p>scalars = c.U_coupling(plane.vertices).max(axis=1)
vert_mask = abs(scalars) &gt; np.max(abs(scalars)/5)
face_index = np.nonzero(plane.faces_sparse.T &#64; vert_mask)[0]
plane = plane.subdivide(face_index)</p>
<p>scalars = c.U_coupling(plane.vertices) &#64; s
vert_mask = abs(scalars) &gt; np.max(abs(scalars)/3)
face_index = np.nonzero(plane.faces_sparse.T &#64; vert_mask)[0]
plane = plane.subdivide(face_index)</p>
<p>scalars = c.U_coupling(plane.vertices) &#64; s
inner = abs(c.U_coupling(plane.vertices).sum(axis=1)) &gt;1e-15
scalars[inner] <a href="#id3"><span class="problematic" id="id4">*</span></a>= -1
m = np.max(abs(scalars))/1.5
surf1 = mlab.triangular_mesh(<a href="#id5"><span class="problematic" id="id6">*</span></a>plane.vertices.T, plane.faces, scalars=scalars,</p>
<blockquote>
<div><p>colormap=âbwrâ, vmin=-m, vmax=m)</p>
</div></blockquote>
<p>surf1.actor.mapper.interpolate_scalars_before_mapping = True
surf1.module_manager.scalar_lut_manager.number_of_colors = 15
surf2 = s.plot(False)
surf2.actor.mapper.interpolate_scalars_before_mapping = True
surf2.module_manager.scalar_lut_manager.number_of_colors = 15</p>
</div></blockquote>
<p>#mlab.triangular_mesh(<a href="#id7"><span class="problematic" id="id8">*</span></a>mesh.vertices.T, mesh.faces, color=(1,1,1))</p>
<p>Calculate magnetic field in a box</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Nvol</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.125</span><span class="p">,</span> <span class="n">Nvol</span><span class="p">)</span>
<span class="n">vol_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="c1"># mlab.points3d(*vol_points.T)</span>

<span class="n">c</span><span class="o">.</span><span class="n">B_coupling</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">Bvol_coupling</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">B_coupling</span><span class="p">(</span><span class="n">vol_points</span><span class="p">,</span> <span class="n">Nchunks</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">analytic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">StreamFunction</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="c1"># s = StreamFunction(a, c)</span>
<span class="n">Bvol</span> <span class="o">=</span> <span class="n">Bvol_coupling</span> <span class="o">@</span> <span class="n">s</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Computing magnetic field coupling matrix analytically, 2562 vertices by 27000 target points... took 75.23 seconds.
</pre></div>
</div>
<p>Plot the computed magnetic field with streamlines</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bfieldtools.mesh_calculus</span> <span class="kn">import</span> <span class="n">gradient</span>

<span class="c1"># mlab.quiver3d(*vol_points.T, *Bvol.T)</span>
<span class="n">mlab</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">bgcolor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">vecs</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">vector_field</span><span class="p">(</span>
    <span class="o">*</span><span class="n">vol_points</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Nvol</span><span class="p">,</span> <span class="n">Nvol</span><span class="p">,</span> <span class="n">Nvol</span><span class="p">),</span> <span class="o">*</span><span class="n">Bvol</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Nvol</span><span class="p">,</span> <span class="n">Nvol</span><span class="p">,</span> <span class="n">Nvol</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">vecnorm</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">extract_vector_norm</span><span class="p">(</span><span class="n">vecs</span><span class="p">)</span>

<span class="n">seed_points</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">mesh</span><span class="o">.</span><span class="n">face_normals</span>
<span class="c1"># c1 = MeshConductor(mesh_obj=mesh, basis_name=&#39;vertex&#39;)</span>
<span class="n">seed_vals</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">basis</span> <span class="o">@</span> <span class="n">c</span><span class="o">.</span><span class="n">inductance</span> <span class="o">@</span> <span class="n">s</span>
<span class="n">seed_vals_grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">gradient</span><span class="p">(</span><span class="n">seed_vals</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">mesh</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mlab</span><span class="o">.</span><span class="n">triangular_mesh</span><span class="p">(</span>
    <span class="o">*</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> <span class="n">scalars</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">seed_vals</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span>
<span class="p">)</span>
<span class="n">seed_vals</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">seed_vals</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">seed_vals</span><span class="p">[</span><span class="n">seed_vals_grad</span> <span class="o">&gt;</span> <span class="n">seed_vals_grad</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="mf">1.8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Npoints</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">seed_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seed_vals</span><span class="p">)),</span> <span class="n">Npoints</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">seed_vals</span> <span class="o">/</span> <span class="n">seed_vals</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">seed_points</span> <span class="o">=</span> <span class="n">seed_points</span><span class="p">[</span><span class="n">seed_inds</span><span class="p">]</span>
<span class="c1"># mlab.points3d(*seed_points.T, scale_factor=0.001)</span>
<span class="c1"># seed_vals /= seed_vals.max()</span>
<span class="c1"># rands = np.random.rand(len(seed_vals))</span>
<span class="c1"># seed_points = seed_points[seed_vals &gt; rands]</span>

<span class="n">streams</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">pi</span> <span class="ow">in</span> <span class="n">seed_points</span><span class="p">:</span>
    <span class="n">streamline</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">streamline</span><span class="p">(</span>
        <span class="n">vecnorm</span><span class="p">,</span>
        <span class="n">integration_direction</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
        <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;BuGn&quot;</span><span class="p">,</span>
        <span class="n">seed_visible</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">seedtype</span><span class="o">=</span><span class="s2">&quot;point&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">streamline</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">pi</span>
    <span class="n">streamline</span><span class="o">.</span><span class="n">stream_tracer</span><span class="o">.</span><span class="n">terminal_speed</span> <span class="o">=</span> <span class="mf">3e-13</span>
    <span class="n">streamline</span><span class="o">.</span><span class="n">stream_tracer</span><span class="o">.</span><span class="n">maximum_propagation</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">streamline</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">render_lines_as_tubes</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">streamline</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">line_width</span> <span class="o">=</span> <span class="mf">4.0</span>
    <span class="n">streams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">streamline</span><span class="p">)</span>


<span class="c1"># Magnetic flux</span>
<span class="c1"># s2 = StreamFunction(c.inductance @ s, c)</span>
<span class="c1"># mlab.figure()</span>
<span class="c1"># surf2 = s2.plot(False)</span>
<span class="c1"># surf2.actor.mapper.interpolate_scalars_before_mapping = True</span>
<span class="c1"># surf2.module_manager.scalar_lut_manager.number_of_colors = 15</span>

<span class="c1"># mlab.figure()</span>
<span class="c1"># surf2 = s.plot(False)</span>
<span class="c1"># surf2.actor.mapper.interpolate_scalars_before_mapping = True</span>
<span class="c1"># surf2.module_manager.scalar_lut_manager.number_of_colors = 16</span>


<span class="c1"># Custom colormap with alpha channel</span>
<span class="n">streamine</span> <span class="o">=</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">lut</span> <span class="o">=</span> <span class="n">streamline</span><span class="o">.</span><span class="n">module_manager</span><span class="o">.</span><span class="n">scalar_lut_manager</span><span class="o">.</span><span class="n">lut</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
<span class="n">lut</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
<span class="n">streamline</span><span class="o">.</span><span class="n">module_manager</span><span class="o">.</span><span class="n">scalar_lut_manager</span><span class="o">.</span><span class="n">lut</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">lut</span>
<span class="n">streamline</span><span class="o">.</span><span class="n">module_manager</span><span class="o">.</span><span class="n">scalar_lut_manager</span><span class="o">.</span><span class="n">data_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0e-13</span><span class="p">,</span> <span class="mf">1.0e-12</span><span class="p">])</span>


<span class="c1">##</span>
<span class="k">for</span> <span class="n">streamline</span> <span class="ow">in</span> <span class="n">streams</span><span class="p">:</span>
    <span class="n">streamline</span><span class="o">.</span><span class="n">stream_tracer</span><span class="o">.</span><span class="n">terminal_speed</span> <span class="o">=</span> <span class="mf">1e-13</span>
    <span class="n">streamline</span><span class="o">.</span><span class="n">seed</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">hot_spot_size</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">streamline</span><span class="o">.</span><span class="n">stream_tracer</span><span class="o">.</span><span class="n">initial_integration_step</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">streamline</span><span class="o">.</span><span class="n">stream_tracer</span><span class="o">.</span><span class="n">minimum_integration_step</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="n">sensors</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">quiver3d</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;cylinder&quot;</span><span class="p">)</span>
<span class="n">sensors</span><span class="o">.</span><span class="n">glyph</span><span class="o">.</span><span class="n">glyph_source</span><span class="o">.</span><span class="n">glyph_source</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">sensors</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">sensors</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">scalar_visibility</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">sensors</span><span class="o">.</span><span class="n">glyph</span><span class="o">.</span><span class="n">glyph_source</span><span class="o">.</span><span class="n">glyph_source</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">sensors</span><span class="o">.</span><span class="n">glyph</span><span class="o">.</span><span class="n">glyph</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">=</span> <span class="mf">0.03</span>
<span class="c1"># sensors.glyph.glyph_source.glyph_source.shaft_radius = 0.05</span>

<span class="n">grad_s</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">basis</span> <span class="o">@</span> <span class="n">s</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">rotated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">quiver3d</span><span class="p">(</span>
    <span class="o">*</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
    <span class="o">*</span><span class="n">grad_s</span><span class="p">,</span>
    <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;arrow&quot;</span>
<span class="p">)</span>

<span class="n">mlab</span><span class="o">.</span><span class="n">triangular_mesh</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">head</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1">##    streamline.seed.widget.enabled = False</span>
<span class="c1">#    streamline.actor.property.line_width = 3.0</span>
</pre></div>
</div>
<img alt="../../_images/sphx_glr_mne_interpolation_008.png" class="sphx-glr-single-img" src="../../_images/sphx_glr_mne_interpolation_008.png" />
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Computing the inductance matrix...
Computing self-inductance matrix using rough quadrature (degree=2).              For higher accuracy, set quad_degree to 4 or more.
Estimating 24058 MiB required for 2562 by 2562 vertices...
Computing inductance matrix in 80 chunks (7475 MiB memory free),              when approx_far=True using more chunks is faster...
Computing triangle-coupling matrix
Inductance matrix computation took 10.80 seconds.

&lt;mayavi.modules.surface.Surface object at 0x7f50e48309b0&gt;
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 5 minutes  59.071 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-publication-software-mne-interpolation-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/1622b98b3616cf59855736b2ed971178/mne_interpolation.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">mne_interpolation.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/c31bc1a95c4f95c86b79962f98f62807/mne_interpolation.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">mne_interpolation.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>


    </div>
    
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2019-2020, bfieldtools developers. Last updated on 2020-05-08.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.4.<br/>
    </p>
  </div>
</footer>
  </body>
</html>