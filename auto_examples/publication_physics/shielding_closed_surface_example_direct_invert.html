<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Design a field of a closed enclosed in a volume &#8212; bfieldtools  documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery-dataframe.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Example of a cylindrical perfect mu-metal shield" href="mumetal_shield_example.html" />
    <link rel="prev" title="Plot different field patterns the basic integrals" href="plot_basic_integrals.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html"><span><img src="../../_static/logo_simple.png"></span>
          bfieldtools</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../overview.html">Overview</a></li>
                <li><a href="../../installation.html">Install</a></li>
                <li><a href="../../literature.html">Literature</a></li>
                <li><a href="../index.html">Examples</a></li>
                <li><a href="../../api_reference.html">API</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../literature.html">Literature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Example gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#coil-design">Coil design</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html#physics-publication-examples">Physics publication examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#software-publication-examples">Software publication examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#thermal-noise-computation">Thermal noise computation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#validation">Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html">API Reference</a></li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-examples-publication-physics-shielding-closed-surface-example-direct-invert-py"><span class="std std-ref">here</span></a>     to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="design-a-field-of-a-closed-enclosed-in-a-volume">
<span id="sphx-glr-auto-examples-publication-physics-shielding-closed-surface-example-direct-invert-py"></span><h1>Design a field of a closed enclosed in a volume<a class="headerlink" href="#design-a-field-of-a-closed-enclosed-in-a-volume" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mayavi</span> <span class="kn">import</span> <span class="n">mlab</span>

<span class="c1"># import trimesh</span>

<span class="kn">from</span> <span class="nn">bfieldtools.mesh_conductor</span> <span class="kn">import</span> <span class="n">MeshConductor</span><span class="p">,</span> <span class="n">StreamFunction</span>
<span class="kn">from</span> <span class="nn">bfieldtools.mesh_magnetics</span> <span class="kn">import</span> <span class="n">magnetic_field_coupling</span> <span class="k">as</span> <span class="n">compute_C</span>
<span class="kn">from</span> <span class="nn">bfieldtools.mesh_magnetics</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">magnetic_field_coupling_analytic</span> <span class="k">as</span> <span class="n">compute_C_analytic</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">bfieldtools.mesh_magnetics</span> <span class="kn">import</span> <span class="n">scalar_potential_coupling</span> <span class="k">as</span> <span class="n">compute_U</span>
<span class="kn">from</span> <span class="nn">bfieldtools.mesh_impedance</span> <span class="kn">import</span> <span class="n">mutual_inductance_matrix</span>
<span class="kn">from</span> <span class="nn">bfieldtools.contour</span> <span class="kn">import</span> <span class="n">scalar_contour</span>
<span class="kn">from</span> <span class="nn">bfieldtools.viz</span> <span class="kn">import</span> <span class="n">plot_3d_current_loops</span>
<span class="kn">from</span> <span class="nn">bfieldtools.sphtools</span> <span class="kn">import</span> <span class="n">compute_sphcoeffs_mesh</span>
<span class="kn">from</span> <span class="nn">bfieldtools.suhtools</span> <span class="kn">import</span> <span class="n">SuhBasis</span>
<span class="kn">from</span> <span class="nn">bfieldtools</span> <span class="kn">import</span> <span class="n">sphtools</span>
<span class="kn">from</span> <span class="nn">bfieldtools.utils</span> <span class="kn">import</span> <span class="n">load_example_mesh</span>

<span class="c1"># domain = &#39;sphere&#39;</span>
<span class="c1"># domain = &#39;cube&#39;</span>
<span class="n">domain</span> <span class="o">=</span> <span class="s2">&quot;combined&quot;</span>

<span class="k">if</span> <span class="n">domain</span> <span class="o">==</span> <span class="s2">&quot;sphere&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">trimesh.creation</span> <span class="kn">import</span> <span class="n">icosphere</span>

    <span class="n">mesh1</span> <span class="o">=</span> <span class="n">icosphere</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.65</span><span class="p">)</span>
    <span class="n">mesh2</span> <span class="o">=</span> <span class="n">icosphere</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">domain</span> <span class="o">==</span> <span class="s2">&quot;cube&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">trimesh.creation</span> <span class="kn">import</span> <span class="n">box</span>
    <span class="kn">from</span> <span class="nn">trimesh.smoothing</span> <span class="kn">import</span> <span class="n">filter_laplacian</span>

    <span class="n">mesh1</span> <span class="o">=</span> <span class="n">box</span><span class="p">((</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
    <span class="n">mesh2</span> <span class="o">=</span> <span class="n">box</span><span class="p">((</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">mesh1</span> <span class="o">=</span> <span class="n">mesh1</span><span class="o">.</span><span class="n">subdivide</span><span class="p">()</span>
        <span class="n">mesh2</span> <span class="o">=</span> <span class="n">mesh2</span><span class="o">.</span><span class="n">subdivide</span><span class="p">()</span>

    <span class="n">mesh1</span> <span class="o">=</span> <span class="n">filter_laplacian</span><span class="p">(</span><span class="n">mesh1</span><span class="p">)</span>
    <span class="n">mesh2</span> <span class="o">=</span> <span class="n">filter_laplacian</span><span class="p">(</span><span class="n">mesh2</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">domain</span> <span class="o">==</span> <span class="s2">&quot;combined&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">trimesh</span>
    <span class="kn">import</span> <span class="nn">pkg_resources</span>
    <span class="kn">from</span> <span class="nn">trimesh.creation</span> <span class="kn">import</span> <span class="n">icosphere</span>

    <span class="n">mesh1</span> <span class="o">=</span> <span class="n">icosphere</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.65</span><span class="p">)</span>
    <span class="n">mesh2</span> <span class="o">=</span> <span class="n">load_example_mesh</span><span class="p">(</span><span class="s2">&quot;cube_fillet&quot;</span><span class="p">)</span>
    <span class="n">mesh2</span><span class="o">.</span><span class="n">vertices</span> <span class="o">-=</span> <span class="n">mesh2</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mesh2</span><span class="o">.</span><span class="n">vertices</span> <span class="o">*=</span> <span class="mf">0.15</span>
<span class="c1">#    mesh2 = mesh2.subdivide()</span>

<span class="n">coil1</span> <span class="o">=</span> <span class="n">MeshConductor</span><span class="p">(</span>
    <span class="n">mesh_obj</span><span class="o">=</span><span class="n">mesh1</span><span class="p">,</span>
    <span class="n">N_sph</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">inductance_nchunks</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">fix_normals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">inductance_quad_degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">coil2</span> <span class="o">=</span> <span class="n">MeshConductor</span><span class="p">(</span>
    <span class="n">mesh_obj</span><span class="o">=</span><span class="n">mesh2</span><span class="p">,</span>
    <span class="n">N_sph</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">inductance_nchunks</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">fix_normals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">inductance_quad_degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">M11</span> <span class="o">=</span> <span class="n">coil1</span><span class="o">.</span><span class="n">inductance</span>
<span class="n">M22</span> <span class="o">=</span> <span class="n">coil2</span><span class="o">.</span><span class="n">inductance</span>
<span class="c1"># Add rank-one matrix, so that M22 can be inverted</span>
<span class="n">M22</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">M22</span><span class="p">)</span> <span class="o">/</span> <span class="n">M22</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">M22</span><span class="p">))</span>
<span class="n">M11</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">M11</span><span class="p">)</span> <span class="o">/</span> <span class="n">M11</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">M11</span><span class="p">))</span>
<span class="n">M21</span> <span class="o">=</span> <span class="n">mutual_inductance_matrix</span><span class="p">(</span><span class="n">mesh2</span><span class="p">,</span> <span class="n">mesh1</span><span class="p">)</span>

<span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">block</span><span class="p">([[</span><span class="n">M11</span><span class="p">,</span> <span class="n">M21</span><span class="o">.</span><span class="n">T</span><span class="p">],</span> <span class="p">[</span><span class="n">M21</span><span class="p">,</span> <span class="n">M22</span><span class="p">]])</span>


<span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">CB1</span> <span class="o">=</span> <span class="n">compute_C_analytic</span><span class="p">(</span><span class="n">mesh1</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>
<span class="n">CB2</span> <span class="o">=</span> <span class="n">compute_C_analytic</span><span class="p">(</span><span class="n">mesh2</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>

<span class="n">CU1</span> <span class="o">=</span> <span class="n">compute_U</span><span class="p">(</span><span class="n">mesh1</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>
<span class="n">CU2</span> <span class="o">=</span> <span class="n">compute_U</span><span class="p">(</span><span class="n">mesh2</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Computing the inductance matrix...
Computing self-inductance matrix using rough quadrature (degree=2).              For higher accuracy, set quad_degree to 4 or more.
Computing triangle-coupling matrix
Inductance matrix computation took 11.40 seconds.
Computing the inductance matrix...
Computing self-inductance matrix using rough quadrature (degree=2).              For higher accuracy, set quad_degree to 4 or more.
Computing triangle-coupling matrix
Inductance matrix computation took 11.39 seconds.
Estimating 24888 MiB required for 2665 by 2562 vertices...
Computing inductance matrix in 60 chunks (10661 MiB memory free),              when approx_far=True using more chunks is faster...
Computing triangle-coupling matrix
Computing magnetic field coupling matrix analytically, 2562 vertices by 10000 target points... took 35.74 seconds.
Computing magnetic field coupling matrix analytically, 2665 vertices by 10000 target points... took 36.15 seconds.
Computing scalar potential coupling matrix, 2562 vertices by 10000 target points... took 31.22 seconds.
Computing scalar potential coupling matrix, 2665 vertices by 10000 target points... took 32.54 seconds.
</pre></div>
</div>
<p>suh = SuhBasis(mesh1, 100)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">b1</span> <span class="o">=</span> <span class="n">mesh1</span><span class="o">.</span><span class="n">vertex_normals</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">b2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mesh1</span><span class="o">.</span><span class="n">vertex_normals</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mesh1</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="o">-</span> <span class="n">mesh1</span><span class="o">.</span><span class="n">vertex_normals</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mesh1</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_plane</span><span class="p">(</span><span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
    <span class="n">mlab</span><span class="o">.</span><span class="n">triangular_mesh</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]),</span>
        <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span>
        <span class="n">opacity</span><span class="o">=</span><span class="n">opacity</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">for</span> <span class="n">bi</span> <span class="ow">in</span> <span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">):</span>

    <span class="n">bb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">bb</span><span class="p">[:</span> <span class="n">M11</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">bi</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">bb</span><span class="p">)</span>
    <span class="n">I1</span> <span class="o">=</span> <span class="n">I</span><span class="p">[:</span> <span class="n">M11</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">I2</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="n">M11</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:]</span>

    <span class="n">B1</span> <span class="o">=</span> <span class="n">CB1</span> <span class="o">@</span> <span class="n">I1</span>
    <span class="n">B2</span> <span class="o">=</span> <span class="n">CB2</span> <span class="o">@</span> <span class="n">I2</span>

    <span class="n">U1</span> <span class="o">=</span> <span class="n">CU1</span> <span class="o">@</span> <span class="n">I1</span>
    <span class="n">U2</span> <span class="o">=</span> <span class="n">CU2</span> <span class="o">@</span> <span class="n">I2</span>

    <span class="c1"># Plot</span>
    <span class="c1"># Extract the cross-sections of the plane and the surfaces</span>
    <span class="n">cc1</span> <span class="o">=</span> <span class="n">scalar_contour</span><span class="p">(</span><span class="n">mesh1</span><span class="p">,</span> <span class="n">mesh1</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">contours</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.001</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cc2</span> <span class="o">=</span> <span class="n">scalar_contour</span><span class="p">(</span><span class="n">mesh2</span><span class="p">,</span> <span class="n">mesh2</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">contours</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.001</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="n">B1</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">B2</span><span class="o">.</span><span class="n">T</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">lw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">lw</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lw</span><span class="p">)</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="c1"># seed_points = 0.51*np.array([xx, -np.sqrt(1-xx**2)])</span>
    <span class="c1"># seed_points = np.hstack([seed_points, (0.51*np.array([xx, np.sqrt(1-xx**2)]))])</span>
    <span class="n">seed_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cc1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cc1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]])</span> <span class="o">*</span> <span class="mf">1.01</span>
    <span class="c1"># plt.streamplot(x,y, B[1], B[0], density=2, linewidth=lw, color=&#39;k&#39;,</span>
    <span class="c1">#               start_points=seed_points.T, integration_direction=&#39;both&#39;)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="p">(</span><span class="n">U1</span> <span class="o">+</span> <span class="n">U2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">U</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;seismic&quot;</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
    <span class="c1"># plt.imshow(U, vmin=-1.0, vmax=1.0, cmap=&#39;seismic&#39;, interpolation=&#39;bicubic&#39;,</span>
    <span class="c1">#           extent=(x.min(), x.max(), y.min(), y.max()))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">streamplot</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">y</span><span class="p">,</span>
        <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">density</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
        <span class="n">start_points</span><span class="o">=</span><span class="n">seed_points</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
        <span class="n">integration_direction</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cc1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cc1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cc2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cc2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>

    <span class="c1"># Plot &quot;coils&quot;</span>
    <span class="n">mlab</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">bgcolor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">contours1</span> <span class="o">=</span> <span class="n">scalar_contour</span><span class="p">(</span><span class="n">mesh1</span><span class="p">,</span> <span class="n">I1</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
    <span class="n">contours2</span> <span class="o">=</span> <span class="n">scalar_contour</span><span class="p">(</span><span class="n">mesh2</span><span class="p">,</span> <span class="n">I2</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>

    <span class="c1">#    fig = plot_3d_current_loops(contours1, tube_radius=0.005, colors=(1,1,1))</span>
    <span class="n">surf</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">triangular_mesh</span><span class="p">(</span>
        <span class="o">*</span><span class="n">mesh1</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">mesh1</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> <span class="n">scalars</span><span class="o">=</span><span class="n">I1</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;seismic&quot;</span>
    <span class="p">)</span>
    <span class="n">surf</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">interpolate_scalars_before_mapping</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">surf</span><span class="o">.</span><span class="n">module_manager</span><span class="o">.</span><span class="n">scalar_lut_manager</span><span class="o">.</span><span class="n">number_of_colors</span> <span class="o">=</span> <span class="mi">16</span>

    <span class="c1">#    plot_3d_current_loops(contours2, tube_radius=0.005, figure=fig, colors=(0,0,0))</span>
    <span class="n">faces2_masked</span> <span class="o">=</span> <span class="n">mesh2</span><span class="o">.</span><span class="n">faces</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">mesh2</span><span class="o">.</span><span class="n">triangles_center</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">&gt;</span> <span class="mf">1.2</span>
    <span class="p">]</span>
    <span class="n">surf</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">triangular_mesh</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">mesh2</span><span class="o">.</span><span class="n">vertices</span> <span class="o">*</span> <span class="mf">0.99</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
        <span class="n">faces2_masked</span><span class="p">,</span>
        <span class="n">scalars</span><span class="o">=</span><span class="n">I2</span><span class="p">,</span>
        <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;seismic&quot;</span><span class="p">,</span>
        <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span>
    <span class="p">)</span>
    <span class="n">surf</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">interpolate_scalars_before_mapping</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">surf</span><span class="o">.</span><span class="n">module_manager</span><span class="o">.</span><span class="n">scalar_lut_manager</span><span class="o">.</span><span class="n">number_of_colors</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">plot_plane</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
<ul class="sphx-glr-horizontal">
<li><img alt="../../_images/sphx_glr_shielding_closed_surface_example_direct_invert_001.png" class="sphx-glr-multi-img" src="../../_images/sphx_glr_shielding_closed_surface_example_direct_invert_001.png" />
</li>
<li><img alt="../../_images/sphx_glr_shielding_closed_surface_example_direct_invert_002.png" class="sphx-glr-multi-img" src="../../_images/sphx_glr_shielding_closed_surface_example_direct_invert_002.png" />
</li>
</ul>
<ul class="sphx-glr-horizontal">
<li><img alt="../../_images/sphx_glr_shielding_closed_surface_example_direct_invert_003.png" class="sphx-glr-multi-img" src="../../_images/sphx_glr_shielding_closed_surface_example_direct_invert_003.png" />
</li>
<li><img alt="../../_images/sphx_glr_shielding_closed_surface_example_direct_invert_004.png" class="sphx-glr-multi-img" src="../../_images/sphx_glr_shielding_closed_surface_example_direct_invert_004.png" />
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mlab</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">bgcolor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">s1</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">triangular_mesh</span><span class="p">(</span>
    <span class="o">*</span><span class="n">mesh1</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">mesh1</span><span class="o">.</span><span class="n">faces</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span>
<span class="p">)</span>
<span class="n">s1</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">backface_culling</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">w1</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">triangular_mesh</span><span class="p">(</span>
    <span class="o">*</span><span class="p">(</span><span class="n">mesh1</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="mf">0.009</span> <span class="o">*</span> <span class="n">mesh1</span><span class="o">.</span><span class="n">vertex_normals</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
    <span class="n">mesh1</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,),</span>
    <span class="n">representation</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span>
<span class="p">)</span>
<span class="n">w1</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">render_lines_as_tubes</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">s2</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">triangular_mesh</span><span class="p">(</span>
    <span class="o">*</span><span class="n">mesh2</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">mesh2</span><span class="o">.</span><span class="n">faces</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span>
<span class="p">)</span>
<span class="n">s2</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">backface_culling</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">faces2_masked</span> <span class="o">=</span> <span class="n">mesh2</span><span class="o">.</span><span class="n">faces</span><span class="p">[(</span><span class="n">mesh2</span><span class="o">.</span><span class="n">triangles_center</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">w2</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">triangular_mesh</span><span class="p">(</span>
    <span class="o">*</span><span class="p">(</span><span class="n">mesh2</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="o">+</span><span class="mf">0.009</span> <span class="o">*</span> <span class="n">mesh2</span><span class="o">.</span><span class="n">vertex_normals</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
    <span class="n">faces2_masked</span><span class="p">,</span>
    <span class="n">representation</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">w2</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">property</span><span class="o">.</span><span class="n">render_lines_as_tubes</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">plot_plane</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../../_images/sphx_glr_shielding_closed_surface_example_direct_invert_005.png" class="sphx-glr-single-img" src="../../_images/sphx_glr_shielding_closed_surface_example_direct_invert_005.png" />
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 2 minutes  48.179 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-publication-physics-shielding-closed-surface-example-direct-invert-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/2f857a6a30686210059347c54325cfcd/shielding_closed_surface_example_direct_invert.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">shielding_closed_surface_example_direct_invert.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/d8bfd95cc9921ca6b055b8454d6dab48/shielding_closed_surface_example_direct_invert.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">shielding_closed_surface_example_direct_invert.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2019-2020, bfieldtools developers. Last updated on 2020-04-29.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.4.<br/>
    </p>
  </div>
</footer>
  </body>
</html>